import{initializeApp as R}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getFirestore as F,collection as N,getDocs as j,doc as U,getDoc as Y}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))b(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const u of c.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&b(u)}).observe(document,{childList:!0,subtree:!0});function m(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function b(r){if(r.ep)return;r.ep=!0;const c=m(r);fetch(r.href,c)}})();let f=null,M=null,w;function S(l,d){function m(P){return P*Math.PI/180}const b=l[0],r=l[1],c=d[0],u=d[1],T=6371,v=u-r,C=m(v),B=c-b,y=m(B),k=Math.sin(C/2)*Math.sin(C/2)+Math.cos(m(r))*Math.cos(m(u))*Math.sin(y/2)*Math.sin(y/2),$=2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k));return T*$}window.showModal=function(l){const d=document.createElement("div");d.setAttribute("id","landmark-modal"),Object.assign(d.style,{position:"fixed",top:"60px",bottom:"60px",left:"0",backgroundColor:"rgba(255, 255, 255, 1)",zIndex:"1000",display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"flex-start",padding:"20px",boxSizing:"border-box",fontFamily:"Arial, sans-serif",color:"#333"});const m=document.createElement("div");m.innerHTML="&times;",Object.assign(m.style,{position:"absolute",top:"20px",right:"20px",fontSize:"30px",cursor:"pointer",color:"#666",zIndex:"1"}),m.onclick=()=>document.body.removeChild(d),d.appendChild(m);const b=document.createElement("h2");b.innerText=`${l.equipment} - ${l.form}`,Object.assign(b.style,{margin:"0",padding:"20px 0",color:"#e55400",fontSize:"24px",borderBottom:"2px solid #e55400",position:"sticky",top:"0"}),d.appendChild(b);const r=document.createElement("div");Object.assign(r.style,{flex:"1",overflowY:"auto",padding:"20px 0"}),d.appendChild(r);const c=document.createElement("div");c.innerHTML=`
            <p><strong>Operation:</strong> ${l.operation}</p>
            <p><strong>Form:</strong> ${l.form}</p>
            <p><strong>Control:</strong> ${l.control}</p>
            <p><strong>Control Framework:</strong> ${l.framework}</p>
            <p><strong>Operating Context:</strong> ${l.context}</p>
            <p><strong>Equipment:</strong> ${l.equipment}</p>
            <p><strong>Assignee:</strong> ${l.assignee?l.assignee.name:""}</p>
            <p><strong>Location</strong></br>
                &emsp;<strong>Lat:</strong> ${l.location.lat}</br>
                &emsp;<strong>Lng:</strong> ${l.location.lng}</p>
            <p><strong>Distance:</strong> ${S([l.location.lng,l.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2)} km</p>
        `,Object.assign(c.style,{marginBottom:"20px",lineHeight:"1.6",fontSize:"16px"}),r.appendChild(c);const u=document.createElement("button");u.innerText=`Perform ${l.form}`,Object.assign(u.style,{backgroundColor:"#e55400",color:"white",border:"none",padding:"12px 24px",borderRadius:"5px",cursor:"pointer",fontSize:"16px",transition:"background-color 0.3s",width:"100%",marginBottom:"20px"}),u.onmouseover=()=>u.style.backgroundColor="#aa3f00",u.onmouseout=()=>u.style.backgroundColor="#e55400",u.onclick=()=>window.open(l.url,"_blank"),d.appendChild(u),document.body.appendChild(d)};window.onload=async()=>{const d=R({apiKey:"AIzaSyAKJ_MIyMk1dIgJYVYP25A2HSFQySsB04g",authDomain:"ccc-data-store.firebaseapp.com",projectId:"ccc-data-store",storageBucket:"ccc-data-store.appspot.com",messagingSenderId:"1084448372624",appId:"1:1084448372624:web:7461eb99124e29f9346515",measurementId:"G-YYC20JLCP7"}),m=F(d),b=N(m,"markers"),r=N(m,"assignees");M=await T();function c(){const n=document.getElementById("compass"),e=n.getContext("2d"),o=document.getElementById("compass-debug");let t=0;function s(i){const x=n.width,I=n.height,E={x:x/2,y:I/2},g=Math.min(x,I)/2-10;o.innerHTML=`
                Heading: ${i.toFixed(1)}°
                <br>Sensor: ${window.DeviceOrientationEvent?"Available":"Not Available"}
                <br>Absolute: ${"ondeviceorientationabsolute"in window?"Yes":"No"}
            `,e.clearRect(0,0,x,I),e.beginPath(),e.arc(E.x,E.y,g,0,Math.PI*2),e.strokeStyle="rgba(255, 255, 255, 0.8)",e.lineWidth=3,e.stroke(),e.beginPath(),e.arc(E.x,E.y,g-10,0,Math.PI*2),e.fillStyle="rgba(0, 0, 0, 0.6)",e.fill(),e.save(),e.translate(E.x,E.y),e.rotate(-i*Math.PI/180),e.beginPath(),e.moveTo(0,-g+15),e.lineTo(-8,0),e.lineTo(8,0),e.closePath(),e.fillStyle="#e55400",e.fill(),e.beginPath(),e.moveTo(0,g-15),e.lineTo(-6,0),e.lineTo(6,0),e.closePath(),e.fillStyle="white",e.fill(),e.fillStyle="white",e.font="16px Arial",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#e55400",e.fillText("N",0,-g+25),e.fillStyle="white",e.fillText("S",0,g-25),e.fillText("E",g-25,0),e.fillText("W",-g+25,0),e.restore()}function p(i){t=i.alpha||0,s(t)}function h(i){i.webkitCompassHeading?t=i.webkitCompassHeading:t=360-i.alpha,s(t)}s(0);const a=document.createElement("div");a.innerHTML=`
        <div style="position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 4px; z-index: 1000;">
            <button onclick="window.testCompassRotation(-10)">←</button>
            <button onclick="window.testCompassRotation(10)">→</button>
        </div>
    `,document.body.appendChild(a),window.testCompassRotation=function(i){t=(t+i)%360,t<0&&(t+=360),s(t)},window.DeviceOrientationEvent?("ondeviceorientationabsolute"in window?(console.log("Absolute orientation is supported"),window.addEventListener("deviceorientationabsolute",p)):(console.log("Using relative orientation"),window.addEventListener("deviceorientation",h)),typeof DeviceOrientationEvent.requestPermission=="function"&&document.getElementById("compass-container").addEventListener("click",async()=>{try{await DeviceOrientationEvent.requestPermission()==="granted"&&("ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",p):window.addEventListener("deviceorientation",h))}catch(i){console.error("Error requesting device orientation permission:",i)}})):(console.log("Device orientation not supported"),document.getElementById("compass-container").style.display="none"),window.addEventListener("resize",()=>{s(t)})}c();async function u(){try{const n=await j(r),e=[];return n.forEach(o=>{e.push({id:o.id,...o.data()})}),console.log("User List:",e),e}catch(n){return console.error("Error reading document: ",n),[]}}async function T(){try{const n=await j(b),e=[];return n.forEach(o=>{e.push({id:o.id,...o.data()})}),console.log("Markers List:",e),e}catch(n){return console.error("Error reading document: ",n),[]}}document.getElementById("loginButton").addEventListener("click",function(){const n=document.getElementById("login-container");n&&(n.style.display="block")}),document.getElementById("assignedToMeButton").addEventListener("click",function(n){const e=document.getElementById("landmark-modal");e!==null&&e.style.display!=="none"&&(e.style.display="none"),n.preventDefault(),$()}),document.getElementById("closeAssignedModal").addEventListener("click",function(){document.getElementById("assigned-modal").style.display="none"});function v(n,e){const o=document.getElementById("toast-container"),t=document.createElement("div");t.textContent=n,t.style.background=e,t.style.color="#fff",t.style.padding="10px 20px",t.style.marginTop="65px",t.style.borderRadius="5px",t.style.fontSize="16px",t.style.textAlign="center",t.style.minWidth="200px",o.appendChild(t),setTimeout(()=>{t.remove()},3e3)}async function C(n,e){try{const t=(await u()).find(s=>s.username===n);t?await P(t.id,e)?(console.log("Login successful"),v("Logged in as "+t.name,"green"),k(t)):v("Invalid password","red"):v("User not found","red")}catch(o){v("An error occurred during login","red"),console.error("Login error:",o)}}function B(){const n=document.getElementById("userMenu");n.querySelector(".dropdown-menu").classList.toggle("active"),n.classList.toggle("active")}let y=null;function k(n){y=n;const e=document.getElementById("userMenu"),o=document.getElementById("userName"),t=document.getElementById("loginButton"),s=document.getElementById("login-container");s.style.display="none",o.textContent=n.name,e.style.display="block",t.style.display="none",e.addEventListener("click",B),O();const h=M.filter(x=>x.assignee&&x.assignee.username===y.username).length;D();const a=document.createElement("span");a.setAttribute("id","notificationCircle"),a.textContent=h,a.style.position="absolute",a.style.top="0px",a.style.left="-23px",a.style.backgroundColor="#ff0000",a.style.color="#fff",a.style.borderRadius="50%",a.style.width="20px",a.style.height="20px",a.style.display="flex",a.style.justifyContent="center",a.style.alignItems="center",a.style.fontSize="12px",o.style.position="relative",o.appendChild(a);const i=document.createElement("span");i.setAttribute("id","assignedNotification"),i.textContent=h,i.style.position="absolute",i.style.top="18px",i.style.right="4px",i.style.backgroundColor="#ff0000",i.style.color="#fff",i.style.borderRadius="50%",i.style.width="20px",i.style.height="20px",i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",i.style.fontSize="12px",assignedToMeButton.style.position="relative",assignedToMeButton.appendChild(i)}async function $(){if(!y){console.error("No user logged in");return}const n=document.getElementById("assigned-modal"),e=document.getElementById("assignedItemsList");e.innerHTML="";try{const t=M.filter(s=>s.assignee).filter(s=>s.assignee.username===y.username);t.length===0?e.innerHTML="<p>No assigned actions.</p>":t.forEach(s=>{const p=document.createElement("div");p.className="assigned-item",p.innerHTML=`
                    <h3>${s.equipment} - ${s.form}</h3>
                    <p><strong>Operation:</strong> ${s.operation}</p>
                    <p><strong>Control:</strong> ${s.control}</p>
                    <p><strong>Location</strong></br>
                        &emsp;<strong>Lat:</strong> ${s.location.lat}</br>
                        &emsp;<strong>Lng:</strong> ${s.location.lng}</p>
                    <p><strong>Distance:</strong> ${S([s.location.lng,s.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2)} km</p>
                    <button class="view-details-btn" data-marker-id="${s.id}">View Details</button>
                `,e.appendChild(p)}),n.style.display="flex",console.log(n.style.zIndex)}catch(o){console.error("Error fetching assigned markers:",o),e.innerHTML="<p>Error loading assigned actions. Please try again later.</p>"}}document.addEventListener("click",n=>{if(n.target&&n.target.classList.contains("view-details-btn")){const e=n.target.getAttribute("data-marker-id"),o=M.find(t=>t.id===e);showModal(o)}}),document.getElementById("signOutButton").addEventListener("click",n=>{n.preventDefault();const e=document.getElementById("userMenu"),o=document.getElementById("loginButton");e.style.display="none",o.style.display="block",document.getElementById("assigned-modal").style.display="none",e.removeEventListener("click",B),y=null,O(),D(),v("Signed out","green"),console.log("User signed out")});async function P(n,e){try{const o=U(m,"assignees",n);return(await Y(o)).data().password===e}catch(o){return console.log(o),!1}}document.getElementById("login-form").addEventListener("submit",function(n){n.preventDefault();const e=n.target.username.value,o=n.target.password.value;C(e,o)}),document.getElementById("loginButton").addEventListener("click",function(){document.getElementById("login-container").style.display="block"}),document.getElementById("closeLogin").addEventListener("click",function(){document.getElementById("login-container").style.display="none"});const z=document.querySelector("a-scene"),A=document.createElement("a-entity");A.setAttribute("cursor","rayOrigin: mouse; fuse: false;"),A.setAttribute("raycaster","objects: a-box, a-gltf-model"),A.setAttribute("raycaster","ignore: [canvas]"),A.setAttribute("raycaster","objects: .clickable; showLine: true;"),z.camera.el.appendChild(A);async function O(){document.querySelectorAll('a-entity[id^="place-"]').forEach(e=>{e.parentNode.removeChild(e)}),M.forEach((e,o)=>{const t=document.createElement("a-entity");t.setAttribute("gps-entity-place",`latitude: ${e.location.lat}; longitude: ${e.location.lng};`),t.setAttribute("look-at","[gps-camera]"),t.setAttribute("scale","6 6 6"),t.setAttribute("class","clickable"),t.setAttribute("id",`place-${o}`);let s,p;y?e.assignee&&e.assignee.username===y.username?(s="#e55400",p="Shiny Amberis-Amur.glb"):(s="white",p="Greyed Shiny Amberis-Amur.glb"):(s="white",p="Shiny Amberis-Amur.glb");const h=document.createElement("a-entity");h.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.3 0",loop:!0,easing:"easeInOutSine"});const a=document.createElement("a-gltf-model");a.setAttribute("src",p),a.setAttribute("scale","0.1 0.1 0.1"),a.setAttribute("class","clickable");let i=0,x=1;const I=Math.PI/16,E=.005;a.addEventListener("model-loaded",()=>{function q(){i+=E*x,Math.abs(i)>=I&&(x*=-1),a.object3D.rotation.y=i,requestAnimationFrame(q)}q()}),h.appendChild(a),t.appendChild(h);const g=document.createElement("a-text"),H=S([e.location.lng,e.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2);g.setAttribute("value",`${e.form}
${e.equipment}
${H} km`),g.setAttribute("color",s),g.setAttribute("align","center"),g.setAttribute("position","0 1.5 0"),g.setAttribute("scale","1.5 1.5 1.5"),g.setAttribute("look-at","[gps-camera]"),g.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 1.5 0",to:"0 1.8 0",loop:!0,easing:"easeInOutSine"}),t.appendChild(g);const L=document.createElement("a-box");L.setAttribute("class","clickable"),L.setAttribute("material","opacity: 0.0"),L.setAttribute("scale","2 2 0"),L.setAttribute("position","0 0 0"),L.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.15 0",loop:!0,easing:"easeInOutSine"}),t.appendChild(L),t.addEventListener("click",function(){showModal(e)}),z.appendChild(t)})}async function D(){let n=!1;M.forEach(t=>{const s=new mapboxgl.Popup({closeButton:!1,closeOnClick:!0}).setHTML(`
                <div style="padding: 10px;">
                    <h3 style="margin: 0 0 5px 0;">${t.equipment} - ${t.form}</h3>
                    <p style="margin: 0;"><strong>Distance:</strong> 
                        ${S([t.location.lng,t.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2)} km
                    </p>
                    <button class="view-details-btn" data-marker-id="${t.id}">View Details</button>
                </div>
            `);let p;y?t.assignee&&t.assignee.username===y.username?p=new mapboxgl.Marker({color:"orange"}).setLngLat([t.location.lng,t.location.lat]).setPopup(s).addTo(w):p=new mapboxgl.Marker({color:"grey"}).setLngLat([t.location.lng,t.location.lat]).setPopup(s).addTo(w):p=new mapboxgl.Marker({color:"orange"}).setLngLat([t.location.lng,t.location.lat]).setPopup(s).addTo(w),p.getElement().addEventListener("click",a=>{if(!n){a.stopPropagation(),e.classList.add("expanded"),o.style.display="block",n=!0,w.resize();return}s.addTo(w)})});const e=document.getElementById("map"),o=document.getElementById("close-map");o.style.position="absolute",o.style.top="51vh",o.style.right="2vw",o.style.padding="8px",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.style.display="none",o.innerHTML='<i class="bi bi-arrows-angle-contract"></i>',e.addEventListener("click",()=>{n||(e.classList.add("expanded"),o.style.display="block",n=!0,w.resize())}),o.addEventListener("click",t=>{t.stopPropagation(),e.classList.remove("expanded"),o.style.display="none",n=!1,w.resize()})}navigator.geolocation.getCurrentPosition(async n=>{f=n,O(),mapboxgl.accessToken="pk.eyJ1IjoiY2hyaXN0aWFuLWJ1cm5zcmVkIiwiYSI6ImNtMjltczVwajA3Z2IyaXBzZGlqNXhtaWkifQ.9FC3d6uBtpOL5sn-LlRoaw",w=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[f.coords.longitude,f.coords.latitude],zoom:13}),D()},n=>{console.error("Error retrieving location",n)},{enableHighAccuracy:!0,maximumAge:0,timeout:27e3})};
