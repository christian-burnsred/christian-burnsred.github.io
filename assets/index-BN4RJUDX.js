import{initializeApp as R}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getFirestore as U,collection as N,getDocs as F,doc as Y,getDoc as _}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";(function(){const g=document.createElement("link").relList;if(g&&g.supports&&g.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))x(c);new MutationObserver(c=>{for(const p of c)if(p.type==="childList")for(const m of p.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&x(m)}).observe(document,{childList:!0,subtree:!0});function y(c){const p={};return c.integrity&&(p.integrity=c.integrity),c.referrerPolicy&&(p.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?p.credentials="include":c.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function x(c){if(c.ep)return;c.ep=!0;const p=y(c);fetch(c.href,p)}})();let f=null,I=null,E;function $(d,g){function y(D){return D*Math.PI/180}const x=d[0],c=d[1],p=g[0],m=g[1],P=6371,M=m-c,B=y(M),O=p-x,h=y(O),k=Math.sin(B/2)*Math.sin(B/2)+Math.cos(y(c))*Math.cos(y(m))*Math.sin(h/2)*Math.sin(h/2),T=2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k));return P*T}window.showModal=function(d){const g=document.createElement("div");g.setAttribute("id","landmark-modal"),Object.assign(g.style,{position:"fixed",top:"60px",bottom:"60px",left:"0",backgroundColor:"rgba(255, 255, 255, 1)",zIndex:"1000",display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"flex-start",padding:"20px",boxSizing:"border-box",fontFamily:"Arial, sans-serif",color:"#333"});const y=document.createElement("div");y.innerHTML="&times;",Object.assign(y.style,{position:"absolute",top:"20px",right:"20px",fontSize:"30px",cursor:"pointer",color:"#666",zIndex:"1"}),y.onclick=()=>document.body.removeChild(g),g.appendChild(y);const x=document.createElement("h2");x.innerText=`${d.equipment} - ${d.form}`,Object.assign(x.style,{margin:"0",padding:"20px 0",color:"#e55400",fontSize:"24px",borderBottom:"2px solid #e55400",position:"sticky",top:"0"}),g.appendChild(x);const c=document.createElement("div");Object.assign(c.style,{flex:"1",overflowY:"auto",padding:"20px 0"}),g.appendChild(c);const p=document.createElement("div");p.innerHTML=`
            <p><strong>Operation:</strong> ${d.operation}</p>
            <p><strong>Form:</strong> ${d.form}</p>
            <p><strong>Control:</strong> ${d.control}</p>
            <p><strong>Control Framework:</strong> ${d.framework}</p>
            <p><strong>Operating Context:</strong> ${d.context}</p>
            <p><strong>Equipment:</strong> ${d.equipment}</p>
            <p><strong>Assignee:</strong> ${d.assignee?d.assignee.name:""}</p>
            <p><strong>Location</strong></br>
                &emsp;<strong>Lat:</strong> ${d.location.lat}</br>
                &emsp;<strong>Lng:</strong> ${d.location.lng}</p>
            <p><strong>Distance:</strong> ${$([d.location.lng,d.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2)} km</p>
        `,Object.assign(p.style,{marginBottom:"20px",lineHeight:"1.6",fontSize:"16px"}),c.appendChild(p);const m=document.createElement("button");m.innerText=`Perform ${d.form}`,Object.assign(m.style,{backgroundColor:"#e55400",color:"white",border:"none",padding:"12px 24px",borderRadius:"5px",cursor:"pointer",fontSize:"16px",transition:"background-color 0.3s",width:"100%",marginBottom:"20px"}),m.onmouseover=()=>m.style.backgroundColor="#aa3f00",m.onmouseout=()=>m.style.backgroundColor="#e55400",m.onclick=()=>window.open(d.url,"_blank"),g.appendChild(m),document.body.appendChild(g)};window.onload=async()=>{const g=R({apiKey:"AIzaSyAKJ_MIyMk1dIgJYVYP25A2HSFQySsB04g",authDomain:"ccc-data-store.firebaseapp.com",projectId:"ccc-data-store",storageBucket:"ccc-data-store.appspot.com",messagingSenderId:"1084448372624",appId:"1:1084448372624:web:7461eb99124e29f9346515",measurementId:"G-YYC20JLCP7"}),y=U(g),x=N(y,"markers"),c=N(y,"assignees");I=await P();function p(){const t=document.getElementById("compass"),e=t.getContext("2d");let n=0;function o(a){const s=t.width,i=t.height,u={x:s/2,y:i/2},w=Math.min(s,i)/2-10;e.clearRect(0,0,s,i),e.save(),e.translate(u.x,u.y),e.rotate(-a*Math.PI/180),e.beginPath(),e.moveTo(0,-w+15),e.lineTo(-8,0),e.lineTo(8,0),e.closePath(),e.fillStyle="#e55400",e.fill(),e.beginPath(),e.moveTo(0,w-15),e.lineTo(-6,0),e.lineTo(6,0),e.closePath(),e.fillStyle="white",e.fill(),e.fillStyle="white",e.font="16px Arial",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#e55400",e.fillText("N",0,-w+5),e.restore()}function l(a){n=a.alpha||0,o(n)}function r(a){a.webkitCompassHeading?n=a.webkitCompassHeading:n=360-a.alpha,o(n)}o(0),window.testCompassRotation=function(a){n=(n+a)%360,n<0&&(n+=360),o(n)},window.DeviceOrientationEvent?("ondeviceorientationabsolute"in window?(console.log("Absolute orientation is supported"),window.addEventListener("deviceorientationabsolute",l)):(console.log("Using relative orientation"),window.addEventListener("deviceorientation",r)),typeof DeviceOrientationEvent.requestPermission=="function"&&document.getElementById("compass-container").addEventListener("click",async()=>{try{await DeviceOrientationEvent.requestPermission()==="granted"&&("ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",l):window.addEventListener("deviceorientation",r))}catch(a){console.error("Error requesting device orientation permission:",a)}})):(console.log("Device orientation not supported"),document.getElementById("compass-container").style.display="none"),window.addEventListener("resize",()=>{o(n)})}p();async function m(){try{const t=await F(c),e=[];return t.forEach(n=>{e.push({id:n.id,...n.data()})}),console.log("User List:",e),e}catch(t){return console.error("Error reading document: ",t),[]}}async function P(){try{const t=await F(x),e=[];return t.forEach(n=>{e.push({id:n.id,...n.data()})}),console.log("Markers List:",e),e}catch(t){return console.error("Error reading document: ",t),[]}}document.getElementById("loginButton").addEventListener("click",function(){const t=document.getElementById("login-container");t&&(t.style.display="block")}),document.getElementById("assignedToMeButton").addEventListener("click",function(t){const e=document.getElementById("landmark-modal");e!==null&&e.style.display!=="none"&&(e.style.display="none"),t.preventDefault(),T()}),document.getElementById("closeAssignedModal").addEventListener("click",function(){document.getElementById("assigned-modal").style.display="none",window.DeviceOrientationEvent&&(window.removeEventListener("deviceorientationabsolute",handleOrientation),window.removeEventListener("deviceorientation",handleOrientation))});function M(t,e){const n=document.getElementById("toast-container"),o=document.createElement("div");o.textContent=t,o.style.background=e,o.style.color="#fff",o.style.padding="10px 20px",o.style.marginTop="65px",o.style.borderRadius="5px",o.style.fontSize="16px",o.style.textAlign="center",o.style.minWidth="200px",n.appendChild(o),setTimeout(()=>{o.remove()},3e3)}async function B(t,e){try{const o=(await m()).find(l=>l.username===t);o?await D(o.id,e)?(console.log("Login successful"),M("Logged in as "+o.name,"green"),k(o)):M("Invalid password","red"):M("User not found","red")}catch(n){M("An error occurred during login","red"),console.error("Login error:",n)}}function O(){const t=document.getElementById("userMenu");t.querySelector(".dropdown-menu").classList.toggle("active"),t.classList.toggle("active")}let h=null;function k(t){h=t;const e=document.getElementById("userMenu"),n=document.getElementById("userName"),o=document.getElementById("loginButton"),l=document.getElementById("login-container");l.style.display="none",n.textContent=t.name,e.style.display="block",o.style.display="none",e.addEventListener("click",O),q();const a=I.filter(u=>u.assignee&&u.assignee.username===h.username).length;z();const s=document.createElement("span");s.setAttribute("id","notificationCircle"),s.textContent=a,s.style.position="absolute",s.style.top="0px",s.style.left="-23px",s.style.backgroundColor="#ff0000",s.style.color="#fff",s.style.borderRadius="50%",s.style.width="20px",s.style.height="20px",s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.fontSize="12px",n.style.position="relative",n.appendChild(s);const i=document.createElement("span");i.setAttribute("id","assignedNotification"),i.textContent=a,i.style.position="absolute",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.right="10px",i.style.backgroundColor="#ff0000",i.style.color="#fff",i.style.borderRadius="50%",i.style.width="20px",i.style.height="20px",i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",i.style.fontSize="12px",assignedToMeButton.style.position="relative",assignedToMeButton.appendChild(i)}async function T(){if(!h){console.error("No user logged in");return}const t=document.getElementById("assigned-modal"),e=document.getElementById("assignedItemsList");e.innerHTML="";function n(){return`
            <svg viewBox="0 0 24 24">
                <path d="M12 2L18 8H6L12 2Z" 
                      fill="#e55400" 
                      stroke="#e55400" 
                      stroke-width="2"/>
            </svg>
        `}function o(r,a,s,i){const u=j=>j*Math.PI/180,w=j=>j*180/Math.PI,A=u(i-a),b=u(r),L=u(s),v=Math.sin(A)*Math.cos(L),S=Math.cos(b)*Math.sin(L)-Math.sin(b)*Math.cos(L)*Math.cos(A);return(w(Math.atan2(v,S))+360)%360}function l(){document.querySelectorAll(".direction-arrow").forEach(a=>{var b,L,v;const s=parseFloat(a.dataset.targetLat),i=parseFloat(a.dataset.targetLng),u=o(f.coords.latitude,f.coords.longitude,s,i);let w=((b=window.deviceOrientation)==null?void 0:b.alpha)||0;((L=window.deviceOrientation)==null?void 0:L.webkitCompassHeading)!==void 0?w=window.deviceOrientation.webkitCompassHeading:((v=window.deviceOrientation)==null?void 0:v.alpha)!==void 0&&(w=360-window.deviceOrientation.alpha);const A=(u-w+360)%360;a.style.transform=`rotate(${A}deg)`})}try{const a=I.filter(s=>s.assignee).filter(s=>s.assignee.username===h.username);if(a.length===0)e.innerHTML="<p>No assigned actions.</p>";else{let s=function(i){window.deviceOrientation=i,l()};a.forEach(i=>{const u=document.createElement("div");u.className="assigned-item",u.innerHTML=`
                    <div style="display: flex; align-items: start; justify-content: space-between;">
                        <div style="flex-grow: 1;">
                            <h3>${i.equipment} - ${i.form}</h3>
                            <p><strong>Operation:</strong> ${i.operation}</p>
                            <p><strong>Control:</strong> ${i.control}</p>
                            <p><strong>Location</strong></br>
                                &emsp;<strong>Lat:</strong> ${i.location.lat}</br>
                                &emsp;<strong>Lng:</strong> ${i.location.lng}</p>
                            <p><strong>Distance:</strong> ${$([i.location.lng,i.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2)} km</p>
                            <button class="view-details-btn" data-marker-id="${i.id}">View Details</button>
                        </div>
                        <div class="direction-arrow" 
                             data-target-lat="${i.location.lat}"
                             data-target-lng="${i.location.lng}">
                            ${n()}
                        </div>
                    </div>
                `,e.appendChild(u)}),window.deviceOrientation={},window.DeviceOrientationEvent&&("ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",s):window.addEventListener("deviceorientation",s),typeof DeviceOrientationEvent.requestPermission=="function"&&DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"&&window.addEventListener("deviceorientation",s)}).catch(console.error)),l()}t.style.display="flex"}catch(r){console.error("Error fetching assigned markers:",r),e.innerHTML="<p>Error loading assigned actions. Please try again later.</p>"}}document.addEventListener("click",t=>{if(t.target&&t.target.classList.contains("view-details-btn")){const e=t.target.getAttribute("data-marker-id"),n=I.find(o=>o.id===e);showModal(n)}}),document.getElementById("signOutButton").addEventListener("click",t=>{t.preventDefault();const e=document.getElementById("userMenu"),n=document.getElementById("loginButton");e.style.display="none",n.style.display="block",document.getElementById("assigned-modal").style.display="none",e.removeEventListener("click",O),h=null,q(),z(),M("Signed out","green"),console.log("User signed out")});async function D(t,e){try{const n=Y(y,"assignees",t);return(await _(n)).data().password===e}catch(n){return console.log(n),!1}}document.getElementById("login-form").addEventListener("submit",function(t){t.preventDefault();const e=t.target.username.value,n=t.target.password.value;B(e,n)}),document.getElementById("loginButton").addEventListener("click",function(){document.getElementById("login-container").style.display="block"}),document.getElementById("closeLogin").addEventListener("click",function(){document.getElementById("login-container").style.display="none"});const H=document.querySelector("a-scene"),C=document.createElement("a-entity");C.setAttribute("cursor","rayOrigin: mouse; fuse: false;"),C.setAttribute("raycaster","objects: a-box, a-gltf-model"),C.setAttribute("raycaster","ignore: [canvas]"),C.setAttribute("raycaster","objects: .clickable; showLine: true;"),H.camera.el.appendChild(C);async function q(){document.querySelectorAll('a-entity[id^="place-"]').forEach(e=>{e.parentNode.removeChild(e)}),I.forEach((e,n)=>{const o=document.createElement("a-entity");o.setAttribute("gps-entity-place",`latitude: ${e.location.lat}; longitude: ${e.location.lng};`),o.setAttribute("look-at","[gps-camera]"),o.setAttribute("scale","6 6 6"),o.setAttribute("class","clickable"),o.setAttribute("id",`place-${n}`);let l,r;h?e.assignee&&e.assignee.username===h.username?(l="#e55400",r="Shiny Amberis-Amur.glb"):(l="white",r="Greyed Shiny Amberis-Amur.glb"):(l="white",r="Shiny Amberis-Amur.glb");const a=document.createElement("a-entity");a.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.3 0",loop:!0,easing:"easeInOutSine"});const s=document.createElement("a-gltf-model");s.setAttribute("src",r),s.setAttribute("scale","0.1 0.1 0.1"),s.setAttribute("class","clickable");let i=0,u=1;const w=Math.PI/16,A=.005;s.addEventListener("model-loaded",()=>{function S(){i+=A*u,Math.abs(i)>=w&&(u*=-1),s.object3D.rotation.y=i,requestAnimationFrame(S)}S()}),a.appendChild(s),o.appendChild(a);const b=document.createElement("a-text"),L=$([e.location.lng,e.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2);b.setAttribute("value",`${e.form}
${e.equipment}
${L} km`),b.setAttribute("color",l),b.setAttribute("align","center"),b.setAttribute("position","0 1.5 0"),b.setAttribute("scale","1.5 1.5 1.5"),b.setAttribute("look-at","[gps-camera]"),b.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 1.5 0",to:"0 1.8 0",loop:!0,easing:"easeInOutSine"}),o.appendChild(b);const v=document.createElement("a-box");v.setAttribute("class","clickable"),v.setAttribute("material","opacity: 0.0"),v.setAttribute("scale","2 2 0"),v.setAttribute("position","0 0 0"),v.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.15 0",loop:!0,easing:"easeInOutSine"}),o.appendChild(v),o.addEventListener("click",function(){showModal(e)}),H.appendChild(o)})}async function z(){let t=!1,e=null;const n=document.createElement("div");n.className="user-marker",n.style.backgroundColor="blue",n.style.width="15px",n.style.height="15px",n.style.borderRadius="50%",n.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.9)",new mapboxgl.Marker(n).setLngLat([f.coords.longitude,f.coords.latitude]).addTo(E),I.forEach(r=>{const a=new mapboxgl.Popup({closeButton:!1,closeOnClick:!0}).setHTML(`
            <div style="padding: 10px;">
                <h3 style="margin: 0 0 5px 0;">${r.equipment} - ${r.form}</h3>
                <p style="margin: 0;"><strong>Distance:</strong> 
                    ${$([r.location.lng,r.location.lat],[f.coords.longitude,f.coords.latitude]).toFixed(2)} km
                </p>
                <button class="view-details-btn" data-marker-id="${r.id}">View Details</button>
            </div>
        `);let s;h?r.assignee&&r.assignee.username===h.username?s=new mapboxgl.Marker({color:"orange"}).setLngLat([r.location.lng,r.location.lat]).setPopup(a).addTo(E):s=new mapboxgl.Marker({color:"grey"}).setLngLat([r.location.lng,r.location.lat]).setPopup(a).addTo(E):s=new mapboxgl.Marker({color:"orange"}).setLngLat([r.location.lng,r.location.lat]).setPopup(a).addTo(E),s.getElement().addEventListener("click",u=>{if(!t){u.stopPropagation(),o.classList.add("expanded"),l.style.display="block",t=!0,E.resize();return}e&&e.remove(),e=a,a.addTo(E)})});const o=document.getElementById("map"),l=document.getElementById("close-map");l.style.position="absolute",l.style.top="calc(100vh - 60px - 40vh)",l.style.right="2vw",l.style.padding="8px",l.style.border="none",l.style.borderRadius="4px",l.style.cursor="pointer",l.style.display="none",l.innerHTML='<i class="bi bi-arrows-angle-contract"></i>',o.addEventListener("click",()=>{t||(o.classList.add("expanded"),l.style.display="block",t=!0,E.resize())}),l.addEventListener("click",r=>{r.stopPropagation(),o.classList.remove("expanded"),l.style.display="none",t=!1,e&&(e.remove(),e=null),E.resize()})}navigator.geolocation.getCurrentPosition(async t=>{f=t,q(),mapboxgl.accessToken="pk.eyJ1IjoiY2hyaXN0aWFuLWJ1cm5zcmVkIiwiYSI6ImNtMjltczVwajA3Z2IyaXBzZGlqNXhtaWkifQ.9FC3d6uBtpOL5sn-LlRoaw",E=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[f.coords.longitude,f.coords.latitude],zoom:15}),z()},t=>{console.error("Error retrieving location",t)},{enableHighAccuracy:!0,maximumAge:0,timeout:27e3})};
