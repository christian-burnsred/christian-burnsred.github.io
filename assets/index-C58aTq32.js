import{initializeApp as R}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getFirestore as U,collection as N,getDocs as F,doc as Y,getDoc as _}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";(function(){const g=document.createElement("link").relList;if(g&&g.supports&&g.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))v(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const m of c.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&v(m)}).observe(document,{childList:!0,subtree:!0});function y(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function v(a){if(a.ep)return;a.ep=!0;const c=y(a);fetch(a.href,c)}})();let b=null,I=null,M;function k(l,g){function y(D){return D*Math.PI/180}const v=l[0],a=l[1],c=g[0],m=g[1],P=6371,A=m-a,B=y(A),O=c-v,h=y(O),$=Math.sin(B/2)*Math.sin(B/2)+Math.cos(y(a))*Math.cos(y(m))*Math.sin(h/2)*Math.sin(h/2),T=2*Math.atan2(Math.sqrt($),Math.sqrt(1-$));return P*T}window.showModal=function(l){const g=document.createElement("div");g.setAttribute("id","landmark-modal"),Object.assign(g.style,{position:"fixed",top:"60px",bottom:"60px",left:"0",backgroundColor:"rgba(255, 255, 255, 1)",zIndex:"1000",display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"flex-start",padding:"20px",boxSizing:"border-box",fontFamily:"Arial, sans-serif",color:"#333"});const y=document.createElement("div");y.innerHTML="&times;",Object.assign(y.style,{position:"absolute",top:"20px",right:"20px",fontSize:"30px",cursor:"pointer",color:"#666",zIndex:"1"}),y.onclick=()=>document.body.removeChild(g),g.appendChild(y);const v=document.createElement("h2");v.innerText=`${l.equipment} - ${l.form}`,Object.assign(v.style,{margin:"0",padding:"20px 0",color:"#e55400",fontSize:"24px",borderBottom:"2px solid #e55400",position:"sticky",top:"0"}),g.appendChild(v);const a=document.createElement("div");Object.assign(a.style,{flex:"1",overflowY:"auto",padding:"20px 0"}),g.appendChild(a);const c=document.createElement("div");c.innerHTML=`
            <p><strong>Operation:</strong> ${l.operation}</p>
            <p><strong>Form:</strong> ${l.form}</p>
            <p><strong>Control:</strong> ${l.control}</p>
            <p><strong>Control Framework:</strong> ${l.framework}</p>
            <p><strong>Operating Context:</strong> ${l.context}</p>
            <p><strong>Equipment:</strong> ${l.equipment}</p>
            <p><strong>Assignee:</strong> ${l.assignee?l.assignee.name:""}</p>
            <p><strong>Location</strong></br>
                &emsp;<strong>Lat:</strong> ${l.location.lat}</br>
                &emsp;<strong>Lng:</strong> ${l.location.lng}</p>
            <p><strong>Distance:</strong> ${k([l.location.lng,l.location.lat],[b.coords.longitude,b.coords.latitude]).toFixed(2)} km</p>
        `,Object.assign(c.style,{marginBottom:"20px",lineHeight:"1.6",fontSize:"16px"}),a.appendChild(c);const m=document.createElement("button");m.innerText=`Perform ${l.form}`,Object.assign(m.style,{backgroundColor:"#e55400",color:"white",border:"none",padding:"12px 24px",borderRadius:"5px",cursor:"pointer",fontSize:"16px",transition:"background-color 0.3s",width:"100%",marginBottom:"20px"}),m.onmouseover=()=>m.style.backgroundColor="#aa3f00",m.onmouseout=()=>m.style.backgroundColor="#e55400",m.onclick=()=>window.open(l.url,"_blank"),g.appendChild(m),document.body.appendChild(g)};window.onload=async()=>{const g=R({apiKey:"AIzaSyAKJ_MIyMk1dIgJYVYP25A2HSFQySsB04g",authDomain:"ccc-data-store.firebaseapp.com",projectId:"ccc-data-store",storageBucket:"ccc-data-store.appspot.com",messagingSenderId:"1084448372624",appId:"1:1084448372624:web:7461eb99124e29f9346515",measurementId:"G-YYC20JLCP7"}),y=U(g),v=N(y,"markers"),a=N(y,"assignees");I=await P();function c(){const n=document.getElementById("compass"),e=n.getContext("2d"),i=document.getElementById("compass-debug");let t=0;function r(o){const s=n.width,p=n.height,E={x:s/2,y:p/2},x=Math.min(s,p)/2-10;i.innerHTML=`
                Heading: ${o.toFixed(1)}Â°
                <br>Sensor: ${window.DeviceOrientationEvent?"Available":"Not Available"}
                <br>Absolute: ${"ondeviceorientationabsolute"in window?"Yes":"No"}
            `,e.clearRect(0,0,s,p),e.save(),e.translate(E.x,E.y),e.rotate(-o*Math.PI/180),e.beginPath(),e.moveTo(0,-x+15),e.lineTo(-8,0),e.lineTo(8,0),e.closePath(),e.fillStyle="#e55400",e.fill(),e.beginPath(),e.moveTo(0,x-15),e.lineTo(-6,0),e.lineTo(6,0),e.closePath(),e.fillStyle="white",e.fill(),e.fillStyle="white",e.font="16px Arial",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#e55400",e.fillText("N",0,-x+5),e.restore()}function d(o){t=o.alpha||0,r(t)}function u(o){o.webkitCompassHeading?t=o.webkitCompassHeading:t=360-o.alpha,r(t)}r(0),window.testCompassRotation=function(o){t=(t+o)%360,t<0&&(t+=360),r(t)},window.DeviceOrientationEvent?("ondeviceorientationabsolute"in window?(console.log("Absolute orientation is supported"),window.addEventListener("deviceorientationabsolute",d)):(console.log("Using relative orientation"),window.addEventListener("deviceorientation",u)),typeof DeviceOrientationEvent.requestPermission=="function"&&document.getElementById("compass-container").addEventListener("click",async()=>{try{await DeviceOrientationEvent.requestPermission()==="granted"&&("ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",d):window.addEventListener("deviceorientation",u))}catch(o){console.error("Error requesting device orientation permission:",o)}})):(console.log("Device orientation not supported"),document.getElementById("compass-container").style.display="none"),window.addEventListener("resize",()=>{r(t)})}c();async function m(){try{const n=await F(a),e=[];return n.forEach(i=>{e.push({id:i.id,...i.data()})}),console.log("User List:",e),e}catch(n){return console.error("Error reading document: ",n),[]}}async function P(){try{const n=await F(v),e=[];return n.forEach(i=>{e.push({id:i.id,...i.data()})}),console.log("Markers List:",e),e}catch(n){return console.error("Error reading document: ",n),[]}}document.getElementById("loginButton").addEventListener("click",function(){const n=document.getElementById("login-container");n&&(n.style.display="block")}),document.getElementById("assignedToMeButton").addEventListener("click",function(n){const e=document.getElementById("landmark-modal");e!==null&&e.style.display!=="none"&&(e.style.display="none"),n.preventDefault(),T()}),document.getElementById("closeAssignedModal").addEventListener("click",function(){document.getElementById("assigned-modal").style.display="none",window.DeviceOrientationEvent&&(window.removeEventListener("deviceorientationabsolute",handleOrientation),window.removeEventListener("deviceorientation",handleOrientation))});function A(n,e){const i=document.getElementById("toast-container"),t=document.createElement("div");t.textContent=n,t.style.background=e,t.style.color="#fff",t.style.padding="10px 20px",t.style.marginTop="65px",t.style.borderRadius="5px",t.style.fontSize="16px",t.style.textAlign="center",t.style.minWidth="200px",i.appendChild(t),setTimeout(()=>{t.remove()},3e3)}async function B(n,e){try{const t=(await m()).find(r=>r.username===n);t?await D(t.id,e)?(console.log("Login successful"),A("Logged in as "+t.name,"green"),$(t)):A("Invalid password","red"):A("User not found","red")}catch(i){A("An error occurred during login","red"),console.error("Login error:",i)}}function O(){const n=document.getElementById("userMenu");n.querySelector(".dropdown-menu").classList.toggle("active"),n.classList.toggle("active")}let h=null;function $(n){h=n;const e=document.getElementById("userMenu"),i=document.getElementById("userName"),t=document.getElementById("loginButton"),r=document.getElementById("login-container");r.style.display="none",i.textContent=n.name,e.style.display="block",t.style.display="none",e.addEventListener("click",O),q();const u=I.filter(p=>p.assignee&&p.assignee.username===h.username).length;z();const o=document.createElement("span");o.setAttribute("id","notificationCircle"),o.textContent=u,o.style.position="absolute",o.style.top="0px",o.style.left="-23px",o.style.backgroundColor="#ff0000",o.style.color="#fff",o.style.borderRadius="50%",o.style.width="20px",o.style.height="20px",o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.fontSize="12px",i.style.position="relative",i.appendChild(o);const s=document.createElement("span");s.setAttribute("id","assignedNotification"),s.textContent=u,s.style.position="absolute",s.style.top="18px",s.style.right="4px",s.style.backgroundColor="#ff0000",s.style.color="#fff",s.style.borderRadius="50%",s.style.width="20px",s.style.height="20px",s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.fontSize="12px",assignedToMeButton.style.position="relative",assignedToMeButton.appendChild(s)}async function T(){if(!h){console.error("No user logged in");return}const n=document.getElementById("assigned-modal"),e=document.getElementById("assignedItemsList");e.innerHTML="";function i(){return`
            <svg viewBox="0 0 24 24">
                <path d="M12 2L18 8H6L12 2Z" 
                      fill="#e55400" 
                      stroke="#e55400" 
                      stroke-width="2"/>
            </svg>
        `}function t(d,u,o,s){const p=H=>H*Math.PI/180,E=H=>H*180/Math.PI,x=p(s-u),f=p(d),L=p(o),w=Math.sin(x)*Math.cos(L),S=Math.cos(f)*Math.sin(L)-Math.sin(f)*Math.cos(L)*Math.cos(x);return(E(Math.atan2(w,S))+360)%360}function r(){document.querySelectorAll(".direction-arrow").forEach(u=>{var f,L,w;const o=parseFloat(u.dataset.targetLat),s=parseFloat(u.dataset.targetLng),p=t(b.coords.latitude,b.coords.longitude,o,s);let E=((f=window.deviceOrientation)==null?void 0:f.alpha)||0;((L=window.deviceOrientation)==null?void 0:L.webkitCompassHeading)!==void 0?E=window.deviceOrientation.webkitCompassHeading:((w=window.deviceOrientation)==null?void 0:w.alpha)!==void 0&&(E=360-window.deviceOrientation.alpha);const x=(p-E+360)%360;u.style.transform=`rotate(${x}deg)`})}try{const u=I.filter(o=>o.assignee).filter(o=>o.assignee.username===h.username);if(u.length===0)e.innerHTML="<p>No assigned actions.</p>";else{let o=function(s){window.deviceOrientation=s,r()};u.forEach(s=>{const p=document.createElement("div");p.className="assigned-item",p.innerHTML=`
                    <div style="display: flex; align-items: start; justify-content: space-between;">
                        <div style="flex-grow: 1;">
                            <h3>${s.equipment} - ${s.form}</h3>
                            <p><strong>Operation:</strong> ${s.operation}</p>
                            <p><strong>Control:</strong> ${s.control}</p>
                            <p><strong>Location</strong></br>
                                &emsp;<strong>Lat:</strong> ${s.location.lat}</br>
                                &emsp;<strong>Lng:</strong> ${s.location.lng}</p>
                            <p><strong>Distance:</strong> ${k([s.location.lng,s.location.lat],[b.coords.longitude,b.coords.latitude]).toFixed(2)} km</p>
                            <button class="view-details-btn" data-marker-id="${s.id}">View Details</button>
                        </div>
                        <div class="direction-arrow" 
                             data-target-lat="${s.location.lat}"
                             data-target-lng="${s.location.lng}">
                            ${i()}
                        </div>
                    </div>
                `,e.appendChild(p)}),window.deviceOrientation={},window.DeviceOrientationEvent&&("ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",o):window.addEventListener("deviceorientation",o),typeof DeviceOrientationEvent.requestPermission=="function"&&DeviceOrientationEvent.requestPermission().then(s=>{s==="granted"&&window.addEventListener("deviceorientation",o)}).catch(console.error)),r()}n.style.display="flex"}catch(d){console.error("Error fetching assigned markers:",d),e.innerHTML="<p>Error loading assigned actions. Please try again later.</p>"}}document.addEventListener("click",n=>{if(n.target&&n.target.classList.contains("view-details-btn")){const e=n.target.getAttribute("data-marker-id"),i=I.find(t=>t.id===e);showModal(i)}}),document.getElementById("signOutButton").addEventListener("click",n=>{n.preventDefault();const e=document.getElementById("userMenu"),i=document.getElementById("loginButton");e.style.display="none",i.style.display="block",document.getElementById("assigned-modal").style.display="none",e.removeEventListener("click",O),h=null,q(),z(),A("Signed out","green"),console.log("User signed out")});async function D(n,e){try{const i=Y(y,"assignees",n);return(await _(i)).data().password===e}catch(i){return console.log(i),!1}}document.getElementById("login-form").addEventListener("submit",function(n){n.preventDefault();const e=n.target.username.value,i=n.target.password.value;B(e,i)}),document.getElementById("loginButton").addEventListener("click",function(){document.getElementById("login-container").style.display="block"}),document.getElementById("closeLogin").addEventListener("click",function(){document.getElementById("login-container").style.display="none"});const j=document.querySelector("a-scene"),C=document.createElement("a-entity");C.setAttribute("cursor","rayOrigin: mouse; fuse: false;"),C.setAttribute("raycaster","objects: a-box, a-gltf-model"),C.setAttribute("raycaster","ignore: [canvas]"),C.setAttribute("raycaster","objects: .clickable; showLine: true;"),j.camera.el.appendChild(C);async function q(){document.querySelectorAll('a-entity[id^="place-"]').forEach(e=>{e.parentNode.removeChild(e)}),I.forEach((e,i)=>{const t=document.createElement("a-entity");t.setAttribute("gps-entity-place",`latitude: ${e.location.lat}; longitude: ${e.location.lng};`),t.setAttribute("look-at","[gps-camera]"),t.setAttribute("scale","6 6 6"),t.setAttribute("class","clickable"),t.setAttribute("id",`place-${i}`);let r,d;h?e.assignee&&e.assignee.username===h.username?(r="#e55400",d="Shiny Amberis-Amur.glb"):(r="white",d="Greyed Shiny Amberis-Amur.glb"):(r="white",d="Shiny Amberis-Amur.glb");const u=document.createElement("a-entity");u.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.3 0",loop:!0,easing:"easeInOutSine"});const o=document.createElement("a-gltf-model");o.setAttribute("src",d),o.setAttribute("scale","0.1 0.1 0.1"),o.setAttribute("class","clickable");let s=0,p=1;const E=Math.PI/16,x=.005;o.addEventListener("model-loaded",()=>{function S(){s+=x*p,Math.abs(s)>=E&&(p*=-1),o.object3D.rotation.y=s,requestAnimationFrame(S)}S()}),u.appendChild(o),t.appendChild(u);const f=document.createElement("a-text"),L=k([e.location.lng,e.location.lat],[b.coords.longitude,b.coords.latitude]).toFixed(2);f.setAttribute("value",`${e.form}
${e.equipment}
${L} km`),f.setAttribute("color",r),f.setAttribute("align","center"),f.setAttribute("position","0 1.5 0"),f.setAttribute("scale","1.5 1.5 1.5"),f.setAttribute("look-at","[gps-camera]"),f.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 1.5 0",to:"0 1.8 0",loop:!0,easing:"easeInOutSine"}),t.appendChild(f);const w=document.createElement("a-box");w.setAttribute("class","clickable"),w.setAttribute("material","opacity: 0.0"),w.setAttribute("scale","2 2 0"),w.setAttribute("position","0 0 0"),w.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.15 0",loop:!0,easing:"easeInOutSine"}),t.appendChild(w),t.addEventListener("click",function(){showModal(e)}),j.appendChild(t)})}async function z(){let n=!1;I.forEach(t=>{const r=new mapboxgl.Popup({closeButton:!1,closeOnClick:!0}).setHTML(`
                <div style="padding: 10px;">
                    <h3 style="margin: 0 0 5px 0;">${t.equipment} - ${t.form}</h3>
                    <p style="margin: 0;"><strong>Distance:</strong> 
                        ${k([t.location.lng,t.location.lat],[b.coords.longitude,b.coords.latitude]).toFixed(2)} km
                    </p>
                    <button class="view-details-btn" data-marker-id="${t.id}">View Details</button>
                </div>
            `);let d;h?t.assignee&&t.assignee.username===h.username?d=new mapboxgl.Marker({color:"orange"}).setLngLat([t.location.lng,t.location.lat]).setPopup(r).addTo(M):d=new mapboxgl.Marker({color:"grey"}).setLngLat([t.location.lng,t.location.lat]).setPopup(r).addTo(M):d=new mapboxgl.Marker({color:"orange"}).setLngLat([t.location.lng,t.location.lat]).setPopup(r).addTo(M),d.getElement().addEventListener("click",o=>{if(!n){o.stopPropagation(),e.classList.add("expanded"),i.style.display="block",n=!0,M.resize();return}r.addTo(M)})});const e=document.getElementById("map"),i=document.getElementById("close-map");i.style.position="absolute",i.style.top="51vh",i.style.right="2vw",i.style.padding="8px",i.style.border="none",i.style.borderRadius="4px",i.style.cursor="pointer",i.style.display="none",i.innerHTML='<i class="bi bi-arrows-angle-contract"></i>',e.addEventListener("click",()=>{n||(e.classList.add("expanded"),i.style.display="block",n=!0,M.resize())}),i.addEventListener("click",t=>{t.stopPropagation(),e.classList.remove("expanded"),i.style.display="none",n=!1,M.resize()})}navigator.geolocation.getCurrentPosition(async n=>{b=n,q(),mapboxgl.accessToken="pk.eyJ1IjoiY2hyaXN0aWFuLWJ1cm5zcmVkIiwiYSI6ImNtMjltczVwajA3Z2IyaXBzZGlqNXhtaWkifQ.9FC3d6uBtpOL5sn-LlRoaw",M=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[b.coords.longitude,b.coords.latitude],zoom:13}),z()},n=>{console.error("Error retrieving location",n)},{enableHighAccuracy:!0,maximumAge:0,timeout:27e3})};
