import{initializeApp as q}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getFirestore as D,collection as v,getDocs as x,doc as j,getDoc as N}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";(function(){const p=document.createElement("link").relList;if(p&&p.supports&&p.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))f(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const g of l.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&f(g)}).observe(document,{childList:!0,subtree:!0});function m(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function f(r){if(r.ep)return;r.ep=!0;const l=m(r);fetch(r.href,l)}})();window.onload=()=>{const p=q({apiKey:"AIzaSyAKJ_MIyMk1dIgJYVYP25A2HSFQySsB04g",authDomain:"ccc-data-store.firebaseapp.com",projectId:"ccc-data-store",storageBucket:"ccc-data-store.appspot.com",messagingSenderId:"1084448372624",appId:"1:1084448372624:web:7461eb99124e29f9346515",measurementId:"G-YYC20JLCP7"}),m=D(p),f=v(m,"markers"),r=v(m,"assignees");async function l(){try{const t=await x(r),n=[];return t.forEach(o=>{n.push({id:o.id,...o.data()})}),console.log("User List:",n),n}catch(t){return console.error("Error reading document: ",t),[]}}async function g(){try{const t=await x(f),n=[];return t.forEach(o=>{n.push({id:o.id,...o.data()})}),console.log("Markers List:",n),n}catch(t){return console.error("Error reading document: ",t),[]}}document.getElementById("loginButton").addEventListener("click",function(){const t=document.getElementById("login-container");t&&(t.style.display="block")}),document.getElementById("assignedToMeButton").addEventListener("click",function(t){t.preventDefault(),$()}),document.getElementById("closeAssignedModal").addEventListener("click",function(){document.getElementById("assigned-modal").style.display="none"});function w(t){const n=document.createElement("div");n.setAttribute("id","marker-details-modal"),document.body.appendChild(n)}async function M(t,n){try{const e=(await l()).find(s=>s.username===t);e?await k(e.id,n)?(console.log("Login successful"),C(e)):alert("Invalid password"):alert("User not found")}catch(o){console.error("Login error:",o)}}function h(){const t=document.getElementById("userMenu");t.querySelector(".dropdown-menu").classList.toggle("active"),t.classList.toggle("active")}let b=null;function C(t){b=t;const n=document.getElementById("userMenu"),o=document.getElementById("userName"),e=document.getElementById("loginButton"),s=document.getElementById("login-container");s.style.display="none",o.textContent=t.name,n.style.display="block",e.style.display="none",n.addEventListener("click",h)}async function $(){if(!b){console.error("No user logged in");return}const t=document.getElementById("assigned-modal"),n=document.getElementById("assignedItemsList");n.innerHTML="";try{const o=await g();console.log(o);const e=o.filter(s=>s.assignee.username===b.username);e.length===0?n.innerHTML="<p>No assigned actions.</p>":(e.forEach(s=>{const i=document.createElement("div");i.className="assigned-item",i.innerHTML=`
                    <h3>${s.equipment} - ${s.form}</h3>
                    <p><strong>Operation:</strong> ${s.operation}</p>
                    <p><strong>Control:</strong> ${s.control}</p>
                    <p><strong>Location</strong></br>
                        &emsp;<strong>Lat:</strong> ${s.location.lat}</br>
                        &emsp;<strong>Lng:</strong> ${s.location.lng}</p>
                    <button class="view-details-btn" data-marker-id="${s.id}">View Details</button>
                `,n.appendChild(i)}),n.querySelectorAll(".view-details-btn").forEach(s=>{s.addEventListener("click",i=>{const d=i.target.getAttribute("data-marker-id"),a=e.find(u=>u.id===d);a&&w(a)})})),t.style.display="flex"}catch(o){console.error("Error fetching assigned markers:",o),n.innerHTML="<p>Error loading assigned actions. Please try again later.</p>"}}document.getElementById("signOutButton").addEventListener("click",t=>{t.preventDefault();const n=document.getElementById("userMenu"),o=document.getElementById("loginButton");n.style.display="none",o.style.display="block",n.removeEventListener("click",h),console.log("User signed out")});async function k(t,n){try{const o=j(m,"assignees",t);return(await N(o)).data().password===n}catch(o){return console.log(o),!1}}document.getElementById("login-form").addEventListener("submit",function(t){t.preventDefault();const n=t.target.username.value,o=t.target.password.value;M(n,o)}),document.getElementById("signOutButton").addEventListener("click",()=>{const t=document.getElementById("userName");t.style.display="none";const n=document.getElementById("signOutButton");n.style.display="none";const o=document.getElementById("loginButton");o&&(o.style.display="inline"),console.log("User signed out")}),document.getElementById("loginButton").addEventListener("click",function(){document.getElementById("login-container").style.display="block"}),document.getElementById("closeLogin").addEventListener("click",function(){document.getElementById("login-container").style.display="none"});const E=document.querySelector("a-scene"),y=document.createElement("a-entity");y.setAttribute("cursor","rayOrigin: mouse; fuse: false;"),y.setAttribute("raycaster","objects: a-box, a-gltf-model"),y.setAttribute("raycaster","ignore: [canvas]"),y.setAttribute("raycaster","objects: .clickable; showLine: true;"),E.camera.el.appendChild(y);function B(t,n){function o(P){return P*Math.PI/180}const e=t[0],s=t[1],i=n[0],d=n[1],a=6371,u=d-s,c=o(u),O=i-e,I=o(O),L=Math.sin(c/2)*Math.sin(c/2)+Math.cos(o(s))*Math.cos(o(d))*Math.sin(I/2)*Math.sin(I/2),S=2*Math.atan2(Math.sqrt(L),Math.sqrt(1-L));return a*S}navigator.geolocation.getCurrentPosition(async t=>{await l(),(await g()).forEach((e,s)=>{const i=document.createElement("a-entity");i.setAttribute("gps-entity-place",`latitude: ${e.location.lat}; longitude: ${e.location.lng};`),i.setAttribute("look-at","[gps-camera]"),i.setAttribute("scale","6 6 6"),i.setAttribute("class","clickable"),i.setAttribute("id",`place-${s}`);const d=document.createElement("a-gltf-model");d.setAttribute("src","Shiny Amberis-Amur.glb"),d.setAttribute("scale","0.1 0.1 0.1"),d.setAttribute("look-at","[gps-camera]"),d.setAttribute("class","clickable"),i.appendChild(d);const a=document.createElement("a-text"),u=B([e.location.lng,e.location.lat],[t.coords.longitude,t.coords.latitude]).toFixed(2);a.setAttribute("value",`${e.equipment}
${u} km`),a.setAttribute("align","center"),a.setAttribute("position","0 1.5 0"),a.setAttribute("scale","1.5 1.5 1.5"),a.setAttribute("look-at","[gps-camera]"),i.appendChild(a);const c=document.createElement("a-box");c.setAttribute("class","clickable"),c.setAttribute("material","color: transparent; opacity: 0.0"),c.setAttribute("scale","2 2 0"),c.setAttribute("position","0 0 0"),i.appendChild(c),i.addEventListener("click",function(){console.log(`Clicked on ${e.equipment}`),o(e)}),E.appendChild(i)});function o(e){const s=document.createElement("div");s.setAttribute("id","landmark-modal"),Object.assign(s.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(255, 255, 255, 0.95)",zIndex:"9999",display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"flex-start",padding:"20px",boxSizing:"border-box",fontFamily:"Arial, sans-serif",color:"#333"});const i=document.createElement("div");i.innerHTML="&times;",Object.assign(i.style,{position:"absolute",top:"20px",right:"20px",fontSize:"30px",cursor:"pointer",color:"#666",zIndex:"1"}),i.onclick=()=>document.body.removeChild(s),s.appendChild(i);const d=document.createElement("h2");d.innerText=`${e.equipment} - ${e.form}`,Object.assign(d.style,{margin:"0",padding:"20px 0",color:"#e55400",fontSize:"24px",borderBottom:"2px solid #e55400",position:"sticky",top:"0"}),s.appendChild(d);const a=document.createElement("div");Object.assign(a.style,{flex:"1",overflowY:"auto",padding:"20px 0"}),s.appendChild(a);const u=document.createElement("div");u.innerHTML=`
            <p><strong>Operation:</strong> ${e.operation}</p>
            <p><strong>Form:</strong> ${e.form}</p>
            <p><strong>Control:</strong> ${e.control}</p>
            <p><strong>Control Framework:</strong> ${e.framework}</p>
            <p><strong>Operating Context:</strong> ${e.context}</p>
            <p><strong>Equipment:</strong> ${e.equipment}</p>
            <p><strong>Assignee:</strong> ${e.assignee.name}</p>
            <p><strong>Location</strong></br>
                &emsp;<strong>Lat:</strong> ${e.location.lat}</br>
                &emsp;<strong>Lng:</strong> ${e.location.lng}</p>
            <p><strong>Distance:</strong> ${B([e.location.lng,e.location.lat],[t.coords.longitude,t.coords.latitude]).toFixed(2)} km</p>
        `,Object.assign(u.style,{marginBottom:"20px",lineHeight:"1.6",fontSize:"16px"}),a.appendChild(u);const c=document.createElement("button");c.innerText=`Perform ${e.form}`,Object.assign(c.style,{backgroundColor:"#e55400",color:"white",border:"none",padding:"12px 24px",borderRadius:"5px",cursor:"pointer",fontSize:"16px",transition:"background-color 0.3s",width:"100%",marginBottom:"20px"}),c.onmouseover=()=>c.style.backgroundColor="#aa3f00",c.onmouseout=()=>c.style.backgroundColor="#e55400",c.onclick=()=>window.open(e.url,"_blank"),s.appendChild(c),document.body.appendChild(s)}},t=>{console.error("Error retrieving location",t)},{enableHighAccuracy:!0,maximumAge:0,timeout:27e3})};
