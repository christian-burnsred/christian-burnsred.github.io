import{initializeApp as F}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getFirestore as H,collection as z,getDocs as D,doc as R,getDoc as U}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))f(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&f(u)}).observe(document,{childList:!0,subtree:!0});function p(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function f(i){if(i.ep)return;i.ep=!0;const l=p(i);fetch(i.href,l)}})();let y=null,M=null,h;function $(r,d){function p(B){return B*Math.PI/180}const f=r[0],i=r[1],l=d[0],u=d[1],x=6371,k=u-i,A=p(k),m=l-f,v=p(m),C=Math.sin(A/2)*Math.sin(A/2)+Math.cos(p(i))*Math.cos(p(u))*Math.sin(v/2)*Math.sin(v/2),S=2*Math.atan2(Math.sqrt(C),Math.sqrt(1-C));return x*S}window.showModal=function(r){const d=document.createElement("div");d.setAttribute("id","landmark-modal"),Object.assign(d.style,{position:"fixed",top:"60px",bottom:"60px",left:"0",backgroundColor:"rgba(255, 255, 255, 1)",zIndex:"1000",display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"flex-start",padding:"20px",boxSizing:"border-box",fontFamily:"Arial, sans-serif",color:"#333"});const p=document.createElement("div");p.innerHTML="&times;",Object.assign(p.style,{position:"absolute",top:"20px",right:"20px",fontSize:"30px",cursor:"pointer",color:"#666",zIndex:"1"}),p.onclick=()=>document.body.removeChild(d),d.appendChild(p);const f=document.createElement("h2");f.innerText=`${r.equipment} - ${r.form}`,Object.assign(f.style,{margin:"0",padding:"20px 0",color:"#e55400",fontSize:"24px",borderBottom:"2px solid #e55400",position:"sticky",top:"0"}),d.appendChild(f);const i=document.createElement("div");Object.assign(i.style,{flex:"1",overflowY:"auto",padding:"20px 0"}),d.appendChild(i);const l=document.createElement("div");l.innerHTML=`
            <p><strong>Operation:</strong> ${r.operation}</p>
            <p><strong>Form:</strong> ${r.form}</p>
            <p><strong>Control:</strong> ${r.control}</p>
            <p><strong>Control Framework:</strong> ${r.framework}</p>
            <p><strong>Operating Context:</strong> ${r.context}</p>
            <p><strong>Equipment:</strong> ${r.equipment}</p>
            <p><strong>Assignee:</strong> ${r.assignee?r.assignee.name:""}</p>
            <p><strong>Location</strong></br>
                &emsp;<strong>Lat:</strong> ${r.location.lat}</br>
                &emsp;<strong>Lng:</strong> ${r.location.lng}</p>
            <p><strong>Distance:</strong> ${$([r.location.lng,r.location.lat],[y.coords.longitude,y.coords.latitude]).toFixed(2)} km</p>
        `,Object.assign(l.style,{marginBottom:"20px",lineHeight:"1.6",fontSize:"16px"}),i.appendChild(l);const u=document.createElement("button");u.innerText=`Perform ${r.form}`,Object.assign(u.style,{backgroundColor:"#e55400",color:"white",border:"none",padding:"12px 24px",borderRadius:"5px",cursor:"pointer",fontSize:"16px",transition:"background-color 0.3s",width:"100%",marginBottom:"20px"}),u.onmouseover=()=>u.style.backgroundColor="#aa3f00",u.onmouseout=()=>u.style.backgroundColor="#e55400",u.onclick=()=>window.open(r.url,"_blank"),d.appendChild(u),document.body.appendChild(d)};window.onload=async()=>{const d=F({apiKey:"AIzaSyAKJ_MIyMk1dIgJYVYP25A2HSFQySsB04g",authDomain:"ccc-data-store.firebaseapp.com",projectId:"ccc-data-store",storageBucket:"ccc-data-store.appspot.com",messagingSenderId:"1084448372624",appId:"1:1084448372624:web:7461eb99124e29f9346515",measurementId:"G-YYC20JLCP7"}),p=H(d),f=z(p,"markers"),i=z(p,"assignees");M=await u();async function l(){try{const n=await D(i),e=[];return n.forEach(o=>{e.push({id:o.id,...o.data()})}),console.log("User List:",e),e}catch(n){return console.error("Error reading document: ",n),[]}}async function u(){try{const n=await D(f),e=[];return n.forEach(o=>{e.push({id:o.id,...o.data()})}),console.log("Markers List:",e),e}catch(n){return console.error("Error reading document: ",n),[]}}document.getElementById("loginButton").addEventListener("click",function(){const n=document.getElementById("login-container");n&&(n.style.display="block")}),document.getElementById("assignedToMeButton").addEventListener("click",function(n){const e=document.getElementById("landmark-modal");e!==null&&e.style.display!=="none"&&(e.style.display="none"),n.preventDefault(),C()}),document.getElementById("closeAssignedModal").addEventListener("click",function(){document.getElementById("assigned-modal").style.display="none"});function x(n,e){const o=document.getElementById("toast-container"),t=document.createElement("div");t.textContent=n,t.style.background=e,t.style.color="#fff",t.style.padding="10px 20px",t.style.marginTop="65px",t.style.borderRadius="5px",t.style.fontSize="16px",t.style.textAlign="center",t.style.minWidth="200px",o.appendChild(t),setTimeout(()=>{t.remove()},3e3)}async function k(n,e){try{const t=(await l()).find(s=>s.username===n);t?await S(t.id,e)?(console.log("Login successful"),x("Logged in as "+t.name,"green"),v(t)):x("Invalid password","red"):x("User not found","red")}catch(o){x("An error occurred during login","red"),console.error("Login error:",o)}}function A(){const n=document.getElementById("userMenu");n.querySelector(".dropdown-menu").classList.toggle("active"),n.classList.toggle("active")}let m=null;function v(n){m=n;const e=document.getElementById("userMenu"),o=document.getElementById("userName"),t=document.getElementById("loginButton"),s=document.getElementById("login-container");s.style.display="none",o.textContent=n.name,e.style.display="block",t.style.display="none",e.addEventListener("click",A),O();const E=M.filter(I=>I.assignee&&I.assignee.username===m.username).length;T();const a=document.createElement("span");a.setAttribute("id","notificationCircle"),a.textContent=E,a.style.position="absolute",a.style.top="0px",a.style.left="-23px",a.style.backgroundColor="#ff0000",a.style.color="#fff",a.style.borderRadius="50%",a.style.width="20px",a.style.height="20px",a.style.display="flex",a.style.justifyContent="center",a.style.alignItems="center",a.style.fontSize="12px",o.style.position="relative",o.appendChild(a);const c=document.createElement("span");c.setAttribute("id","assignedNotification"),c.textContent=E,c.style.position="absolute",c.style.top="18px",c.style.right="4px",c.style.backgroundColor="#ff0000",c.style.color="#fff",c.style.borderRadius="50%",c.style.width="20px",c.style.height="20px",c.style.display="flex",c.style.justifyContent="center",c.style.alignItems="center",c.style.fontSize="12px",assignedToMeButton.style.position="relative",assignedToMeButton.appendChild(c)}async function C(){if(!m){console.error("No user logged in");return}const n=document.getElementById("assigned-modal"),e=document.getElementById("assignedItemsList");e.innerHTML="";try{const t=M.filter(s=>s.assignee).filter(s=>s.assignee.username===m.username);t.length===0?e.innerHTML="<p>No assigned actions.</p>":t.forEach(s=>{const g=document.createElement("div");g.className="assigned-item",g.innerHTML=`
                    <h3>${s.equipment} - ${s.form}</h3>
                    <p><strong>Operation:</strong> ${s.operation}</p>
                    <p><strong>Control:</strong> ${s.control}</p>
                    <p><strong>Location</strong></br>
                        &emsp;<strong>Lat:</strong> ${s.location.lat}</br>
                        &emsp;<strong>Lng:</strong> ${s.location.lng}</p>
                    <p><strong>Distance:</strong> ${$([s.location.lng,s.location.lat],[y.coords.longitude,y.coords.latitude]).toFixed(2)} km</p>
                    <button class="view-details-btn" data-marker-id="${s.id}">View Details</button>
                `,e.appendChild(g)}),n.style.display="flex",console.log(n.style.zIndex)}catch(o){console.error("Error fetching assigned markers:",o),e.innerHTML="<p>Error loading assigned actions. Please try again later.</p>"}}document.addEventListener("click",n=>{if(n.target&&n.target.classList.contains("view-details-btn")){const e=n.target.getAttribute("data-marker-id"),o=M.find(t=>t.id===e);showModal(o)}}),document.getElementById("signOutButton").addEventListener("click",n=>{n.preventDefault();const e=document.getElementById("userMenu"),o=document.getElementById("loginButton");e.style.display="none",o.style.display="block",document.getElementById("assigned-modal").style.display="none",e.removeEventListener("click",A),m=null,O(),T(),x("Signed out","green"),console.log("User signed out")});async function S(n,e){try{const o=R(p,"assignees",n);return(await U(o)).data().password===e}catch(o){return console.log(o),!1}}document.getElementById("login-form").addEventListener("submit",function(n){n.preventDefault();const e=n.target.username.value,o=n.target.password.value;k(e,o)}),document.getElementById("loginButton").addEventListener("click",function(){document.getElementById("login-container").style.display="block"}),document.getElementById("closeLogin").addEventListener("click",function(){document.getElementById("login-container").style.display="none"});const B=document.querySelector("a-scene"),w=document.createElement("a-entity");w.setAttribute("cursor","rayOrigin: mouse; fuse: false;"),w.setAttribute("raycaster","objects: a-box, a-gltf-model"),w.setAttribute("raycaster","ignore: [canvas]"),w.setAttribute("raycaster","objects: .clickable; showLine: true;"),B.camera.el.appendChild(w);async function O(){document.querySelectorAll('a-entity[id^="place-"]').forEach(e=>{e.parentNode.removeChild(e)}),M.forEach((e,o)=>{const t=document.createElement("a-entity");t.setAttribute("gps-entity-place",`latitude: ${e.location.lat}; longitude: ${e.location.lng};`),t.setAttribute("look-at","[gps-camera]"),t.setAttribute("scale","6 6 6"),t.setAttribute("class","clickable"),t.setAttribute("id",`place-${o}`);let s,g;m?e.assignee&&e.assignee.username===m.username?(s="#e55400",g="Shiny Amberis-Amur.glb"):(s="white",g="Greyed Shiny Amberis-Amur.glb"):(s="white",g="Shiny Amberis-Amur.glb");const E=document.createElement("a-entity");E.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.3 0",loop:!0,easing:"easeInOutSine"});const a=document.createElement("a-gltf-model");a.setAttribute("src",g),a.setAttribute("scale","0.1 0.1 0.1"),a.setAttribute("class","clickable");let c=0,I=1;const j=Math.PI/16,q=.005;a.addEventListener("model-loaded",()=>{function P(){c+=q*I,Math.abs(c)>=j&&(I*=-1),a.object3D.rotation.y=c,requestAnimationFrame(P)}P()}),E.appendChild(a),t.appendChild(E);const b=document.createElement("a-text"),N=$([e.location.lng,e.location.lat],[y.coords.longitude,y.coords.latitude]).toFixed(2);b.setAttribute("value",`${e.form}
${e.equipment}
${N} km`),b.setAttribute("color",s),b.setAttribute("align","center"),b.setAttribute("position","0 1.5 0"),b.setAttribute("scale","1.5 1.5 1.5"),b.setAttribute("look-at","[gps-camera]"),b.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 1.5 0",to:"0 1.8 0",loop:!0,easing:"easeInOutSine"}),t.appendChild(b);const L=document.createElement("a-box");L.setAttribute("class","clickable"),L.setAttribute("material","opacity: 0.0"),L.setAttribute("scale","2 2 0"),L.setAttribute("position","0 0 0"),L.setAttribute("animation__bob",{property:"position",dir:"alternate",dur:2e3,from:"0 0 0",to:"0 0.15 0",loop:!0,easing:"easeInOutSine"}),t.appendChild(L),t.addEventListener("click",function(){showModal(e)}),B.appendChild(t)})}async function T(){let n=!1;M.forEach(t=>{const s=new mapboxgl.Popup({closeButton:!1,closeOnClick:!0}).setHTML(`
                <div style="padding: 10px;">
                    <h3 style="margin: 0 0 5px 0;">${t.equipment} - ${t.form}</h3>
                    <p style="margin: 0;"><strong>Distance:</strong> 
                        ${$([t.location.lng,t.location.lat],[y.coords.longitude,y.coords.latitude]).toFixed(2)} km
                    </p>
                    <button class="view-details-btn" data-marker-id="${t.id}">View Details</button>
                </div>
            `);let g;m?t.assignee&&t.assignee.username===m.username?g=new mapboxgl.Marker({color:"orange"}).setLngLat([t.location.lng,t.location.lat]).setPopup(s).addTo(h):g=new mapboxgl.Marker({color:"grey"}).setLngLat([t.location.lng,t.location.lat]).setPopup(s).addTo(h):g=new mapboxgl.Marker({color:"orange"}).setLngLat([t.location.lng,t.location.lat]).setPopup(s).addTo(h),g.getElement().addEventListener("click",a=>{if(!n){a.stopPropagation(),e.classList.add("expanded"),o.style.display="block",n=!0,h.resize();return}s.addTo(h)})});const e=document.getElementById("map"),o=document.getElementById("close-map");o.style.position="absolute",o.style.top="51vh",o.style.right="2vw",o.style.padding="8px",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.style.display="none",o.innerHTML='<i class="bi bi-arrows-angle-contract"></i>',e.addEventListener("click",()=>{n||(e.classList.add("expanded"),o.style.display="block",n=!0,h.resize())}),o.addEventListener("click",t=>{t.stopPropagation(),e.classList.remove("expanded"),o.style.display="none",n=!1,h.resize()})}navigator.geolocation.getCurrentPosition(async n=>{y=n,O(),mapboxgl.accessToken="pk.eyJ1IjoiY2hyaXN0aWFuLWJ1cm5zcmVkIiwiYSI6ImNtMjltczVwajA3Z2IyaXBzZGlqNXhtaWkifQ.9FC3d6uBtpOL5sn-LlRoaw",h=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[y.coords.longitude,y.coords.latitude],zoom:13}),T()},n=>{console.error("Error retrieving location",n)},{enableHighAccuracy:!0,maximumAge:0,timeout:27e3})};
