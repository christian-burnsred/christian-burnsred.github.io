import{initializeApp as q}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";import{getFirestore as N,collection as B,getDocs as $,doc as F,getDoc as H}from"https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";(function(){const p=document.createElement("link").relList;if(p&&p.supports&&p.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))x(a);new MutationObserver(a=>{for(const d of a)if(d.type==="childList")for(const y of d.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&x(y)}).observe(document,{childList:!0,subtree:!0});function m(a){const d={};return a.integrity&&(d.integrity=a.integrity),a.referrerPolicy&&(d.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?d.credentials="include":a.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function x(a){if(a.ep)return;a.ep=!0;const d=m(a);fetch(a.href,d)}})();let g=null,E=null;window.onload=async()=>{const p=q({apiKey:"AIzaSyAKJ_MIyMk1dIgJYVYP25A2HSFQySsB04g",authDomain:"ccc-data-store.firebaseapp.com",projectId:"ccc-data-store",storageBucket:"ccc-data-store.appspot.com",messagingSenderId:"1084448372624",appId:"1:1084448372624:web:7461eb99124e29f9346515",measurementId:"G-YYC20JLCP7"}),m=N(p),x=B(m,"markers"),a=B(m,"assignees");E=await y();async function d(){try{const e=await $(a),n=[];return e.forEach(t=>{n.push({id:t.id,...t.data()})}),console.log("User List:",n),n}catch(e){return console.error("Error reading document: ",e),[]}}async function y(){try{const e=await $(x),n=[];return e.forEach(t=>{n.push({id:t.id,...t.data()})}),console.log("Markers List:",n),n}catch(e){return console.error("Error reading document: ",e),[]}}document.getElementById("loginButton").addEventListener("click",function(){const e=document.getElementById("login-container");e&&(e.style.display="block")}),document.getElementById("assignedToMeButton").addEventListener("click",function(e){e.preventDefault(),T()}),document.getElementById("closeAssignedModal").addEventListener("click",function(){document.getElementById("assigned-modal").style.display="none"});function f(e,n){const t=document.getElementById("toast-container"),o=document.createElement("div");o.textContent=e,o.style.background=n,o.style.color="#fff",o.style.padding="10px 20px",o.style.marginTop="65px",o.style.borderRadius="5px",o.style.fontSize="16px",o.style.textAlign="center",o.style.minWidth="200px",t.appendChild(o),setTimeout(()=>{o.remove()},3e3)}async function k(e,n){try{const o=(await d()).find(s=>s.username===e);o?await P(o.id,n)?(console.log("Login successful"),f("Logged in as "+o.name,"green"),O(o)):f("Invalid password","red"):f("User not found","red")}catch(t){f("An error occurred during login","red"),console.error("Login error:",t)}}function C(){const e=document.getElementById("userMenu");e.querySelector(".dropdown-menu").classList.toggle("active"),e.classList.toggle("active")}let u=null;function O(e){u=e;const n=document.getElementById("userMenu"),t=document.getElementById("userName"),o=document.getElementById("loginButton"),s=document.getElementById("login-container");s.style.display="none",t.textContent=e.name,n.style.display="block",o.style.display="none",n.addEventListener("click",C),L();const i=E.filter(h=>h.assignee&&h.assignee.username===u.username).length,c=document.createElement("span");c.setAttribute("id","notificationCircle"),c.textContent=i,c.style.position="absolute",c.style.top="0px",c.style.left="-23px",c.style.backgroundColor="#ff0000",c.style.color="#fff",c.style.borderRadius="50%",c.style.width="20px",c.style.height="20px",c.style.display="flex",c.style.justifyContent="center",c.style.alignItems="center",c.style.fontSize="12px",t.style.position="relative",t.appendChild(c);const r=document.createElement("span");r.setAttribute("id","assignedNotification"),r.textContent=i,r.style.position="absolute",r.style.top="18px",r.style.right="4px",r.style.backgroundColor="#ff0000",r.style.color="#fff",r.style.borderRadius="50%",r.style.width="20px",r.style.height="20px",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.fontSize="12px",assignedToMeButton.style.position="relative",assignedToMeButton.appendChild(r)}async function T(){if(!u){console.error("No user logged in");return}const e=document.getElementById("assigned-modal"),n=document.getElementById("assignedItemsList");n.innerHTML="";try{const o=E.filter(s=>s.assignee).filter(s=>s.assignee.username===u.username);o.length===0?n.innerHTML="<p>No assigned actions.</p>":(o.forEach(s=>{const l=document.createElement("div");l.className="assigned-item",l.innerHTML=`
                    <h3>${s.equipment} - ${s.form}</h3>
                    <p><strong>Operation:</strong> ${s.operation}</p>
                    <p><strong>Control:</strong> ${s.control}</p>
                    <p><strong>Location</strong></br>
                        &emsp;<strong>Lat:</strong> ${s.location.lat}</br>
                        &emsp;<strong>Lng:</strong> ${s.location.lng}</p>
                    <p><strong>Distance:</strong> ${A([s.location.lng,s.location.lat],[g.coords.longitude,g.coords.latitude]).toFixed(2)} km</p>
                    <button class="view-details-btn" data-marker-id="${s.id}">View Details</button>
                `,n.appendChild(l)}),n.querySelectorAll(".view-details-btn").forEach(s=>{s.addEventListener("click",l=>{const i=l.target.getAttribute("data-marker-id");console.log(i);const c=o.find(r=>r.id===i);c&&M(c)})})),e.style.display="flex",console.log(e.style.zIndex)}catch(t){console.error("Error fetching assigned markers:",t),n.innerHTML="<p>Error loading assigned actions. Please try again later.</p>"}}document.getElementById("signOutButton").addEventListener("click",e=>{e.preventDefault();const n=document.getElementById("userMenu"),t=document.getElementById("loginButton");n.style.display="none",t.style.display="block",document.getElementById("assigned-modal").style.display="none",n.removeEventListener("click",C),u=null,L(),f("Signed out","green"),console.log("User signed out")});async function P(e,n){try{const t=F(m,"assignees",e);return(await H(t)).data().password===n}catch(t){return console.log(t),!1}}document.getElementById("login-form").addEventListener("submit",function(e){e.preventDefault();const n=e.target.username.value,t=e.target.password.value;k(n,t)}),document.getElementById("loginButton").addEventListener("click",function(){document.getElementById("login-container").style.display="block"}),document.getElementById("closeLogin").addEventListener("click",function(){document.getElementById("login-container").style.display="none"});const I=document.querySelector("a-scene"),b=document.createElement("a-entity");b.setAttribute("cursor","rayOrigin: mouse; fuse: false;"),b.setAttribute("raycaster","objects: a-box, a-gltf-model"),b.setAttribute("raycaster","ignore: [canvas]"),b.setAttribute("raycaster","objects: .clickable; showLine: true;"),I.camera.el.appendChild(b);function A(e,n){function t(j){return j*Math.PI/180}const o=e[0],s=e[1],l=n[0],i=n[1],c=6371,r=i-s,h=t(r),z=l-o,v=t(z),w=Math.sin(h/2)*Math.sin(h/2)+Math.cos(t(s))*Math.cos(t(i))*Math.sin(v/2)*Math.sin(v/2),D=2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w));return c*D}function M(e){const n=document.createElement("div");n.setAttribute("id","landmark-modal"),Object.assign(n.style,{position:"fixed",top:"60px",bottom:"60px",left:"0",backgroundColor:"rgba(255, 255, 255, 1)",zIndex:"1000",display:"flex",flexDirection:"column",alignItems:"stretch",justifyContent:"flex-start",padding:"20px",boxSizing:"border-box",fontFamily:"Arial, sans-serif",color:"#333"});const t=document.createElement("div");t.innerHTML="&times;",Object.assign(t.style,{position:"absolute",top:"20px",right:"20px",fontSize:"30px",cursor:"pointer",color:"#666",zIndex:"1"}),t.onclick=()=>document.body.removeChild(n),n.appendChild(t);const o=document.createElement("h2");o.innerText=`${e.equipment} - ${e.form}`,Object.assign(o.style,{margin:"0",padding:"20px 0",color:"#e55400",fontSize:"24px",borderBottom:"2px solid #e55400",position:"sticky",top:"0"}),n.appendChild(o);const s=document.createElement("div");Object.assign(s.style,{flex:"1",overflowY:"auto",padding:"20px 0"}),n.appendChild(s);const l=document.createElement("div");l.innerHTML=`
            <p><strong>Operation:</strong> ${e.operation}</p>
            <p><strong>Form:</strong> ${e.form}</p>
            <p><strong>Control:</strong> ${e.control}</p>
            <p><strong>Control Framework:</strong> ${e.framework}</p>
            <p><strong>Operating Context:</strong> ${e.context}</p>
            <p><strong>Equipment:</strong> ${e.equipment}</p>
            <p><strong>Assignee:</strong> ${e.assignee?e.assignee.name:""}</p>
            <p><strong>Location</strong></br>
                &emsp;<strong>Lat:</strong> ${e.location.lat}</br>
                &emsp;<strong>Lng:</strong> ${e.location.lng}</p>
            <p><strong>Distance:</strong> ${A([e.location.lng,e.location.lat],[g.coords.longitude,g.coords.latitude]).toFixed(2)} km</p>
        `,Object.assign(l.style,{marginBottom:"20px",lineHeight:"1.6",fontSize:"16px"}),s.appendChild(l);const i=document.createElement("button");i.innerText=`Perform ${e.form}`,Object.assign(i.style,{backgroundColor:"#e55400",color:"white",border:"none",padding:"12px 24px",borderRadius:"5px",cursor:"pointer",fontSize:"16px",transition:"background-color 0.3s",width:"100%",marginBottom:"20px"}),i.onmouseover=()=>i.style.backgroundColor="#aa3f00",i.onmouseout=()=>i.style.backgroundColor="#e55400",i.onclick=()=>window.open(e.url,"_blank"),n.appendChild(i),document.body.appendChild(n)}async function L(){E.forEach((e,n)=>{const t=document.createElement("a-entity");t.setAttribute("gps-entity-place",`latitude: ${e.location.lat}; longitude: ${e.location.lng};`),t.setAttribute("look-at","[gps-camera]"),t.setAttribute("scale","6 6 6"),t.setAttribute("class","clickable"),t.setAttribute("id",`place-${n}`);let o,s;u?e.assignee&&e.assignee.username===u.username?(o="#e55400",s="Shiny Amberis-Amur.glb"):(o="white",s="Greyed Shiny Amberis-Amur.glb"):(o="white",s="Shiny Amberis-Amur.glb");const l=document.createElement("a-gltf-model");l.setAttribute("src",s),l.setAttribute("scale","0.1 0.1 0.1"),l.setAttribute("look-at","[gps-camera]"),l.setAttribute("class","clickable"),t.appendChild(l);const i=document.createElement("a-text"),c=A([e.location.lng,e.location.lat],[g.coords.longitude,g.coords.latitude]).toFixed(2);i.setAttribute("value",`${e.equipment}
${c} km`),i.setAttribute("color",o),i.setAttribute("align","center"),i.setAttribute("position","0 1.5 0"),i.setAttribute("scale","1.5 1.5 1.5"),i.setAttribute("look-at","[gps-camera]"),t.appendChild(i);const r=document.createElement("a-box");r.setAttribute("class","clickable"),r.setAttribute("material","opacity: 0.0"),r.setAttribute("scale","2 2 0"),r.setAttribute("position","0 0 0"),t.appendChild(r),t.addEventListener("click",function(){console.log(`Clicked on ${e.equipment}`),M(e)}),I.appendChild(t)})}navigator.geolocation.getCurrentPosition(async e=>{g=e,L()},e=>{console.error("Error retrieving location",e)},{enableHighAccuracy:!0,maximumAge:0,timeout:27e3})};
